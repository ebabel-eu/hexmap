<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Hex Map Generator</title>
  <style>
    :root {
      --terrain-desert: #dddddd;
      --terrain-swamp: #bbbbbb;
      --terrain-grassland: #999999;
      --terrain-forest: #777777;
      --terrain-river: #555555;
      --terrain-ocean: #333333;
      --terrain-mountain: #111111;
    }

    body {
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      font-size: 12px;
    }

    canvas {
      background-color: #ffffff;
      display: block;
      margin: auto;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 20px;
      background: white;
      z-index: 1;
    }

    ul {
      padding-left: 0;
      margin: 0;
    }

    ul li {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid #000;
    }

    .context-menu {
      position: absolute;
      display: none;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 5px;
      cursor: pointer;
    }

    .context-menu-item:hover {
      background-color: #eee;
    }

    #buttons {
      position: absolute;
      top: 10px;
      z-index: 2;
    }

    @media print {
      #buttons {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div id="buttons">
    <button id="newMapButton">New Map</button>
    <button id="toggleDangerButton">DM / Players</button>
    <button id="toggleColorMode">Colour / Gray</button>
  </div>

  <div class="legend">
    <ul>
      <li><span class="swatch" id="swatch-desert" style="background: var(--terrain-desert);"></span> Desert</li>
      <li><span class="swatch" id="swatch-swamp" style="background: var(--terrain-swamp);"></span> Swamp</li>
      <li><span class="swatch" id="swatch-grassland" style="background: var(--terrain-grassland);"></span> Grassland
      </li>
      <li><span class="swatch" id="swatch-forest" style="background: var(--terrain-forest);"></span> Forest</li>
      <li><span class="swatch" id="swatch-river" style="background: var(--terrain-river);"></span> River</li>
      <li><span class="swatch" id="swatch-ocean" style="background: var(--terrain-ocean);"></span> Ocean</li>
      <li><span class="swatch" id="swatch-mountain" style="background: var(--terrain-mountain);"></span> Mountain</li>
    </ul>
    <ul>
      <li>Walking: 4 hours</li>
      <li>Mounted: 2 hours</li>
      <li>Sailing: 1 hour</li>
      <li>Arduous terrain: 8 hours</li>
      <li>Difficult terrain: time x2</li>
      <li>&nbsp;</li>
      <li>Safe, Unsafe, Risky, Deadly</li>
    </ul>
  </div>

  <canvas id="hexMap" width="1000" height="1000"></canvas>
  <div id="contextMenu" class="context-menu"></div>
  <div id="poiList" style="display: block;"></div>

  <script>
    const canvas = document.getElementById('hexMap');
    const ctx = canvas.getContext('2d');
    const contextMenu = document.getElementById('contextMenu');
    const toggleColorMode = document.getElementById('toggleColorMode');
    const newMapButton = document.getElementById('newMapButton');
    const toggleDangerButton = document.getElementById('toggleDangerButton');
    const poiListDiv = document.getElementById('poiList');

    const HEX_RADIUS = 44;
    const MAP_RADIUS = 6;
    const HEX_COLOR = '#000000';

    let useGrayscale = false;
    let showDanger = true;
    let seed = Math.floor(Math.random() * 99999);

    let terrainMap = new Map();
    let dangerMap = new Map();
    let poiMap = new Map();
    let hexNumberMap = new Map();

    const poiDescriptions = [
      "Small tower", "Fortified keep", "Natural landmark", "Natural landmark", "Temple", "Barrow mounds",
      "Village", "Village", "Town", "Town", "City", "Ravine", "Monster nest", "Monster nest",
      "Hermit's abode", "Cave formation", "Cave formation", "Ancient dolmens", "Barbarian camp", "Holy shrine"
    ];
    const villageNames = [
      "Bruga's Hold", "Lastwatch", "Darkwater", "Ostlin",
      "Treefall", "Vorn", "Hillshire", "Nighthaven"
    ];
    const townNames = [
      "Fairhollow", "Ivan's Keep", "Galina", "Brightlantern",
      "Corvin's Crest", "Ironbridge", "Skalvin", "Toresk"
    ];
    const cityNames = [
      "Doraine", "Meridia", "King's Gate", "Myrkhos",
      "Rularn", "Ordos", "Thane", "Rahgbat"
    ];

    function seededRandom(seed) {
      let x = Math.sin(seed++) * 10000;
      return x - Math.floor(x);
    }

    function seededChoice(seedRef, choices) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return choices[Math.floor(val * choices.length)];
    }

    function seededD6(seedRef) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return Math.floor(val * 6) + 1;
    }

    function seededD8(seedRef) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return Math.floor(val * 8) + 1;
    }

    function seededD20(seedRef) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return Math.floor(val * 20);
    }

    function dangerLevelSymbol(roll) {
      if (roll === 1) return 'S';
      if (roll <= 3) return 'U';
      if (roll <= 5) return 'R';
      return 'D';
    }

    const baseTerrainTypes = [
      { name: "Desert", grayscale: '#dddddd', color: '#fceabb' },
      { name: "Swamp", grayscale: '#bbbbbb', color: '#c6e2c1' },
      { name: "Grassland", grayscale: '#999999', color: '#d5f5c9' },
      { name: "Forest", grayscale: '#777777', color: '#b0d9af' },
      { name: "River", grayscale: '#555555', color: '#ccefff' },
      { name: "Ocean", grayscale: '#333333', color: '#b2d4ee' },
      { name: "Mountain", grayscale: '#111111', color: '#ddd3c1' }
    ];

    function getTerrainColor(terrain) {
      return useGrayscale ? terrain.grayscale : terrain.color;
    }

    function updateLegendSwatches() {
      baseTerrainTypes.forEach(t => {
        const el = document.getElementById(`swatch-${t.name.toLowerCase()}`);
        if (el) el.style.background = getTerrainColor(t);
      });
    }

    function hexToPixel(q, r, size) {
      const x = size * Math.sqrt(3) * (q + r / 2);
      const y = size * 3 / 2 * r;
      return [x, y];
    }

    function getHexSpiral(radius) {
      const results = [{ q: 0, r: 0 }];
      const directions = [
        { q: 1, r: 0 }, { q: 1, r: -1 }, { q: 0, r: -1 },
        { q: -1, r: 0 }, { q: -1, r: 1 }, { q: 0, r: 1 }
      ];
      for (let k = 1; k <= radius; k++) {
        let q = directions[4].q * k;
        let r = directions[4].r * k;
        for (let side = 0; side < 6; side++) {
          const dir = directions[side];
          for (let step = 0; step < k; step++) {
            results.push({ q, r });
            q += dir.q;
            r += dir.r;
          }
        }
      }
      return results;
    }

    function drawHex(x, y, size, fillColor, label, terrainName, dangerSymbol, hasPOI) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 180 * (60 * i - 30);
        const px = x + size * Math.cos(angle);
        const py = y + size * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fillStyle = fillColor;
      ctx.fill();
      ctx.strokeStyle = HEX_COLOR;
      ctx.lineWidth = 2;
      ctx.stroke();

      const blackTextTerrains = ["Desert", "Swamp"];
      const textColor = (!useGrayscale || blackTextTerrains.includes(terrainName)) ? '#000' : '#fff';
      ctx.fillStyle = textColor;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.font = '11px sans-serif';
      ctx.fillText(label, x, y - 10);

      ctx.font = '10px sans-serif';
      ctx.fillText(showDanger ? `${terrainName} - ${dangerSymbol}` : terrainName, x, y + 6);

      if (showDanger && hasPOI) {
        ctx.font = 'bold 9px sans-serif';
        ctx.fillText("PoI", x, y + 20);
      }
    }

    function drawGrid(drawOnly = false) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!drawOnly) {
        terrainMap.clear();
        dangerMap.clear();
        poiMap.clear();
        hexNumberMap.clear();
        poiListDiv.innerHTML = '';
      }

      const coords = getHexSpiral(MAP_RADIUS);
      const seedRef = { value: seed };
      let previousTerrain = seededChoice(seedRef, baseTerrainTypes);
      const poiEntries = [];

      coords.forEach(({ q, r }, index) => {
        const hexId = index + 1;
        const key = `${q},${r}`;
        hexNumberMap.set(key, hexId);

        let terrain = terrainMap.get(key);
        if (!drawOnly || !terrain) {
          if (seededRandom(seedRef.value++) < 1 / 36) {
            let newTerrain;
            do {
              newTerrain = seededChoice(seedRef, baseTerrainTypes);
            } while (newTerrain === previousTerrain);
            previousTerrain = newTerrain;
          }
          terrain = previousTerrain;
          terrainMap.set(key, terrain);
        }

        let danger = dangerMap.get(key);
        if (!drawOnly || !danger) {
          const dangerRoll = seededD6(seedRef);
          danger = dangerLevelSymbol(dangerRoll);
          dangerMap.set(key, danger);
        }

        let hasPOI = poiMap.has(key);
        if (!drawOnly && seededD6(seedRef) === 1) {
          let poiType = poiDescriptions[seededD20(seedRef)];

          if (poiType === "Village") {
            poiType += ": " + villageNames[seededD8(seedRef) - 1];
          } else if (poiType === "Town") {
            poiType += ": " + townNames[seededD8(seedRef) - 1];
          } else if (poiType === "City") {
            poiType += ": " + cityNames[seededD8(seedRef) - 1];
          }

          poiMap.set(key, poiType);
          poiEntries.push(`<li><strong>${hexId}</strong>: ${poiType}</li>`);
          hasPOI = true;
        }

        const [x, y] = hexToPixel(q, r, HEX_RADIUS);
        drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), hexId, terrain.name, danger, hasPOI);
      });

      if (showDanger && poiMap.size > 0) {
        const listItems = [...poiMap.entries()].map(([key, val]) => {
          const id = hexNumberMap.get(key);
          return `<li><strong>${id}</strong>: ${val}</li>`;
        });
        poiListDiv.innerHTML = `<h3>Points of Interest (DM only)</h3><ul>${listItems.join('')}</ul>`;
        poiListDiv.style.display = 'block';
      } else {
        poiListDiv.innerHTML = '';
        poiListDiv.style.display = 'none';
      }
    }

    function redrawHex(q, r) {
      const key = `${q},${r}`;
      const terrain = terrainMap.get(key);
      const danger = dangerMap.get(key);
      const hasPOI = poiMap.has(key);
      const hexId = hexNumberMap.get(key);
      const [x, y] = hexToPixel(q, r, HEX_RADIUS);
      drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), hexId, terrain.name, danger, hasPOI);
    }

    toggleColorMode.addEventListener('click', () => {
      useGrayscale = !useGrayscale;
      updateLegendSwatches();
      for (const key of terrainMap.keys()) {
        const [q, r] = key.split(',').map(Number);
        redrawHex(q, r);
      }
    });

    toggleDangerButton.addEventListener('click', () => {
      showDanger = !showDanger;
      drawGrid(true);
    });

    newMapButton.addEventListener('click', () => {
      seed = Math.floor(Math.random() * 99999);
      drawGrid(false);
    });

    canvas.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const size = HEX_RADIUS;
      const q = ((mouseX - canvas.width / 2) * Math.sqrt(3) / 3 - (mouseY - canvas.height / 2) / 3) / size;
      const r = ((mouseY - canvas.height / 2) * 2 / 3) / size;
      const rounded = hexRound(q, r);
      const key = `${rounded.q},${rounded.r}`;
      if (!terrainMap.has(key)) return;

      contextMenu.innerHTML = '';
      baseTerrainTypes.forEach(t => {
        const item = document.createElement('div');
        item.className = 'context-menu-item';
        item.innerHTML = `<span class="swatch" style="background:${getTerrainColor(t)}"></span>${t.name}`;
        item.onclick = () => {
          terrainMap.set(key, t);
          redrawHex(rounded.q, rounded.r);
          contextMenu.style.display = 'none';
        };
        contextMenu.appendChild(item);
      });

      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.style.display = 'block';
    });

    function hexRound(qf, rf) {
      const sf = -qf - rf;
      let q = Math.round(qf);
      let r = Math.round(rf);
      let s = Math.round(sf);
      const dq = Math.abs(q - qf);
      const dr = Math.abs(r - rf);
      const ds = Math.abs(s - sf);
      if (dq > dr && dq > ds) q = -r - s;
      else if (dr > ds) r = -q - s;
      return { q, r };
    }

    window.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });

    drawGrid();
    updateLegendSwatches();
  </script>
</body>

</html>