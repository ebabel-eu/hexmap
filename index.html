<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Hex Map Generator</title>
  <style>
    :root {
      --terrain-desert: #dddddd;
      --terrain-swamp: #bbbbbb;
      --terrain-grassland: #999999;
      --terrain-forest: #777777;
      --terrain-river: #555555;
      --terrain-ocean: #333333;
      --terrain-mountain: #111111;
    }

    body {
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      font-size: 12px;
    }

    canvas {
      background-color: #ffffff;
      display: block;
      margin: auto;
    }

    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 20px;
      background: white;
      z-index: 1;
    }

    ul {
      padding-left: 0;
      margin: 0;
    }

    ul li {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid #000;
    }

    .context-menu {
      position: absolute;
      display: none;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 5px;
      cursor: pointer;
    }

    .context-menu-item:hover {
      background-color: #eee;
    }

    #buttons {
      position: absolute;
      top: 10px;
      z-index: 2;
    }

    @media print {
      #buttons {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div id="buttons">
    <button id="newMapButton">New Map</button>
    <button id="toggleDangerButton">DM / Players</button>
    <button id="toggleColorMode">Colour / Gray</button>
  </div>

  <div class="legend">
    <ul>
      <li><span class="swatch" id="swatch-desert" style="background: var(--terrain-desert);"></span> Desert</li>
      <li><span class="swatch" id="swatch-swamp" style="background: var(--terrain-swamp);"></span> Swamp</li>
      <li><span class="swatch" id="swatch-grassland" style="background: var(--terrain-grassland);"></span> Grassland
      </li>
      <li><span class="swatch" id="swatch-forest" style="background: var(--terrain-forest);"></span> Forest</li>
      <li><span class="swatch" id="swatch-river" style="background: var(--terrain-river);"></span> River</li>
      <li><span class="swatch" id="swatch-ocean" style="background: var(--terrain-ocean);"></span> Ocean</li>
      <li><span class="swatch" id="swatch-mountain" style="background: var(--terrain-mountain);"></span> Mountain</li>
    </ul>
    <ul>
      <li>Walking: 4 hours</li>
      <li>Mounted: 2 hours</li>
      <li>Sailing: 1 hour</li>
      <li>Arduous terrain: 8 hours</li>
      <li>Difficult terrain: time x2</li>
      <li>&nbsp;</li>
      <li>Safe, Unsafe, Risky, Deadly</li>
    </ul>
  </div>

  <canvas id="hexMap" width="1000" height="1000"></canvas>
  <div id="contextMenu" class="context-menu"></div>

  <div id="poiList" style="display: block;"></div>

  <script>
    const canvas = document.getElementById('hexMap');
    const ctx = canvas.getContext('2d');
    const contextMenu = document.getElementById('contextMenu');
    const toggleColorMode = document.getElementById('toggleColorMode');
    const newMapButton = document.getElementById('newMapButton');
    const toggleDangerButton = document.getElementById('toggleDangerButton');
    const poiListDiv = document.getElementById('poiList');

    const HEX_RADIUS = 44;
    const MAP_RADIUS = 6;
    const HEX_COLOR = '#000000';

    let useGrayscale = false;
    let showDanger = true;
    let seed = Math.floor(Math.random() * 99999);

    let terrainMap = new Map();
    let dangerMap = new Map();
    let poiMap = new Map();

    const poiDescriptions = [
      "Small tower", "Fortified keep", "Natural landmark", "Natural landmark", "Temple", "Barrow mounds",
      "Village", "Village", "Town", "Town", "City", "Ravine", "Monster nest", "Monster nest",
      "Hermit's abode", "Cave formation", "Cave formation", "Ancient dolmens", "Barbarian camp", "Holy shrine"
    ];

    function seededRandom(seed) {
      let x = Math.sin(seed++) * 10000;
      return x - Math.floor(x);
    }

    function seededChoice(seedRef, choices) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return choices[Math.floor(val * choices.length)];
    }

    function seededD6(seedRef) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return Math.floor(val * 6) + 1;
    }

    function seededD20(seedRef) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return Math.floor(val * 20);
    }

    function dangerLevelSymbol(roll) {
      if (roll === 1) return 'S';
      if (roll <= 3) return 'U';
      if (roll <= 5) return 'R';
      return 'D';
    }

    const baseTerrainTypes = [
      { name: "Desert", grayscale: '#dddddd', color: '#fceabb' },
      { name: "Swamp", grayscale: '#bbbbbb', color: '#c6e2c1' },
      { name: "Grassland", grayscale: '#999999', color: '#d5f5c9' },
      { name: "Forest", grayscale: '#777777', color: '#b0d9af' },
      { name: "River", grayscale: '#555555', color: '#ccefff' },
      { name: "Ocean", grayscale: '#333333', color: '#b2d4ee' },
      { name: "Mountain", grayscale: '#111111', color: '#ddd3c1' }
    ];

    function getTerrainColor(terrain) {
      return useGrayscale ? terrain.grayscale : terrain.color;
    }

    function updateLegendSwatches() {
      baseTerrainTypes.forEach(t => {
        const el = document.getElementById(`swatch-${t.name.toLowerCase()}`);
        if (el) el.style.background = getTerrainColor(t);
      });
    }

    function hexToPixel(q, r, size) {
      const x = size * Math.sqrt(3) * (q + r / 2);
      const y = size * 3 / 2 * r;
      return [x, y];
    }

    function pixelToHex(x, y) {
      const size = HEX_RADIUS;
      const q = ((x - canvas.width / 2) * Math.sqrt(3) / 3 - (y - canvas.height / 2) / 3) / size;
      const r = ((y - canvas.height / 2) * 2 / 3) / size;
      return hexRound(q, r);
    }

    function hexRound(qf, rf) {
      const sf = -qf - rf;
      let q = Math.round(qf);
      let r = Math.round(rf);
      let s = Math.round(sf);

      const dq = Math.abs(q - qf);
      const dr = Math.abs(r - rf);
      const ds = Math.abs(s - sf);

      if (dq > dr && dq > ds) q = -r - s;
      else if (dr > ds) r = -q - s;

      return { q, r };
    }

    function drawHex(x, y, size, fillColor, label, terrainName, dangerSymbol, hasPOI) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 180 * (60 * i - 30);
        const px = x + size * Math.cos(angle);
        const py = y + size * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fillStyle = fillColor;
      ctx.fill();
      ctx.strokeStyle = HEX_COLOR;
      ctx.lineWidth = 2;
      ctx.stroke();

      const blackTextTerrains = ["Desert", "Swamp"];
      const textColor = (!useGrayscale || blackTextTerrains.includes(terrainName)) ? '#000' : '#fff';
      ctx.fillStyle = textColor;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.font = '11px sans-serif';
      ctx.fillText(label, x, y - 10);

      ctx.font = '10px sans-serif';
      ctx.fillText(showDanger ? `${terrainName} - ${dangerSymbol}` : terrainName, x, y + 6);

      if (showDanger && hasPOI) {
        ctx.font = 'bold 9px sans-serif';
        ctx.fillText("PoI", x, y + 20);
      }
    }

    function getHexSpiral(radius) {
      const results = [{ q: 0, r: 0 }];
      const directions = [
        { q: 1, r: 0 }, { q: 1, r: -1 }, { q: 0, r: -1 },
        { q: -1, r: 0 }, { q: -1, r: 1 }, { q: 0, r: 1 }
      ];

      for (let k = 1; k <= radius; k++) {
        let q = directions[4].q * k;
        let r = directions[4].r * k;

        for (let side = 0; side < 6; side++) {
          const dir = directions[side];
          for (let step = 0; step < k; step++) {
            results.push({ q, r });
            q += dir.q;
            r += dir.r;
          }
        }
      }
      return results;
    }

    // ... existing variable declarations ...

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const previousTerrainMap = new Map(terrainMap); // preserve manual changes
      terrainMap.clear();
      dangerMap.clear();
      poiMap.clear();
      poiListDiv.innerHTML = '';

      const coords = getHexSpiral(MAP_RADIUS);
      const seedRef = { value: seed };
      let previousTerrain = seededChoice(seedRef, baseTerrainTypes);
      const poiEntries = [];

      for (const { q, r } of coords) {
        const key = `${q},${r}`;

        if (seededRandom(seedRef.value++) < 1 / 36) {
          let newTerrain;
          do {
            newTerrain = seededChoice(seedRef, baseTerrainTypes);
          } while (newTerrain === previousTerrain);
          previousTerrain = newTerrain;
        }

        const terrain = previousTerrainMap.get(key) || previousTerrain;
        terrainMap.set(key, terrain);

        const dangerRoll = seededD6(seedRef);
        const dangerSymbol = dangerLevelSymbol(dangerRoll);
        dangerMap.set(key, dangerSymbol);

        let hasPOI = false;
        if (seededD6(seedRef) === 1) {
          const poiType = poiDescriptions[seededD20(seedRef)];
          poiMap.set(key, poiType);
          poiEntries.push(`<li><strong>Hex ${q},${r}</strong>: ${poiType}</li>`);
          hasPOI = true;
        }

        const [x, y] = hexToPixel(q, r, HEX_RADIUS);
        drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), key, terrain.name, dangerSymbol, hasPOI);
      }

      if (showDanger && poiEntries.length > 0) {
        poiListDiv.innerHTML = `<h3>Points of Interest (DM only)</h3><ul>${poiEntries.join('')}</ul>`;
        poiListDiv.style.display = 'block';
      } else {
        poiListDiv.innerHTML = '';
        poiListDiv.style.display = 'none';
      }
    }

    function redrawHex(q, r) {
      const terrain = terrainMap.get(`${q},${r}`);
      const danger = dangerMap.get(`${q},${r}`);
      const hasPOI = poiMap.has(`${q},${r}`);
      const [x, y] = hexToPixel(q, r, HEX_RADIUS);
      drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), `${q},${r}`, terrain.name, danger, hasPOI);
    }

    toggleColorMode.addEventListener('click', () => {
      useGrayscale = !useGrayscale;
      updateLegendSwatches();
      for (const key of terrainMap.keys()) {
        const [q, r] = key.split(',').map(Number);
        redrawHex(q, r);
      }
    });

    toggleDangerButton.addEventListener('click', () => {
      showDanger = !showDanger;
      drawGrid(); // ✅ Redraw full grid and toggle #poiList visibility
    });

    newMapButton.addEventListener('click', () => {
      seed = Math.floor(Math.random() * 99999);
      drawGrid();
    });

    canvas.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const { q, r } = pixelToHex(mouseX, mouseY);

      if (!terrainMap.has(`${q},${r}`)) return;

      contextMenu.innerHTML = '';
      baseTerrainTypes.forEach(t => {
        const item = document.createElement('div');
        item.className = 'context-menu-item';
        item.innerHTML = `<span class="swatch" style="background:${getTerrainColor(t)}"></span>${t.name}`;
        item.onclick = () => {
          terrainMap.set(`${q},${r}`, t);
          redrawHex(q, r);
          contextMenu.style.display = 'none';
        };
        contextMenu.appendChild(item);
      });

      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.style.display = 'block';
    });

    window.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });

    drawGrid();
    updateLegendSwatches();
  </script>
</body>

</html>