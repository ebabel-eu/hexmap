<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Hex Map Generator</title>
  <style>
    :root {
      --terrain-desert: #dddddd;
      --terrain-swamp: #bbbbbb;
      --terrain-grassland: #999999;
      --terrain-forest: #777777;
      --terrain-river: #555555;
      --terrain-ocean: #333333;
      --terrain-mountain: #111111;
    }

    body {
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      font-size: 12px;
    }

    canvas {
      background-color: #ffffff;
      display: block;
      margin: auto;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 20px;
      background: white;
      z-index: 1;
    }

    ul {
      padding-left: 0;
      margin: 0;
    }

    ul li {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid #000;
    }

    .context-menu {
      position: absolute;
      display: none;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 5px;
      cursor: pointer;
    }

    .context-menu-item:hover {
      background-color: #eee;
    }

    #buttons {
      position: absolute;
      top: 10px;
      z-index: 2;
    }

    @media print {
      #buttons {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div id="buttons">
    <button id="newMapButton">New Map</button>
    <button id="toggleDangerButton">DM / Players</button>
    <button id="toggleColorMode">Colour / Gray</button>
  </div>

  <div class="legend">
    <ul>
      <li><span class="swatch" id="swatch-desert" style="background: var(--terrain-desert);"></span> Desert</li>
      <li><span class="swatch" id="swatch-swamp" style="background: var(--terrain-swamp);"></span> Swamp</li>
      <li><span class="swatch" id="swatch-grassland" style="background: var(--terrain-grassland);"></span> Grassland
      </li>
      <li><span class="swatch" id="swatch-forest" style="background: var(--terrain-forest);"></span> Forest</li>
      <li><span class="swatch" id="swatch-river" style="background: var(--terrain-river);"></span> River</li>
      <li><span class="swatch" id="swatch-ocean" style="background: var(--terrain-ocean);"></span> Ocean</li>
      <li><span class="swatch" id="swatch-mountain" style="background: var(--terrain-mountain);"></span> Mountain</li>
    </ul>
    <ul>
      <li>Walking: 4 hours</li>
      <li>Mounted: 2 hours</li>
      <li>Sailing: 1 hour</li>
      <li>Arduous terrain: 8 hours</li>
      <li>Difficult terrain: time x2</li>
      <li>&nbsp;</li>
      <li>Safe, Unsafe, Risky, Deadly</li>
    </ul>
  </div>

  <canvas id="hexMap" width="1000" height="1000"></canvas>
  <div id="contextMenu" class="context-menu"></div>
  <div id="poiList" style="display: block;"></div>

  <script>
    // --- GET DOM ELEMENTS ---
    const canvas = document.getElementById('hexMap');
    const ctx = canvas.getContext('2d');
    const contextMenu = document.getElementById('contextMenu');
    const toggleColorMode = document.getElementById('toggleColorMode');
    const newMapButton = document.getElementById('newMapButton');
    const toggleDangerButton = document.getElementById('toggleDangerButton');
    const poiListDiv = document.getElementById('poiList');

    // --- CONSTANTS ---
    const HEX_RADIUS = 44;
    const MAP_RADIUS = 6;
    const HEX_COLOR = '#000000';

    let useGrayscale = false;
    let showDanger = true;
    let seed = Math.floor(Math.random() * 99999);

    let terrainMap = new Map();
    let dangerMap = new Map();
    let poiMap = new Map();
    let hexNumberMap = new Map();

    const poiDescriptions = [
      "Tower", "Fort", "Ancient ruins", "Temple", "Tumulus",
      "Village", "Village", "Village", "Village", "Village", "Village", "Town", "Town", "Town", "City",
      "Ravine", "Creatures nest", "Creatures lair", "Hermit's shelter", "Cave", "Cemetery",
      "Standing stones", "Barbarian encampment", "Divine shrine",
      "Abandoned watchpost", "Ruined lighthouse", "Obsidian obelisk", "Sunken crypt", "Hidden waterfall",
      "Goblin den", "Wizard's tower", "Cursed battlefield", "Fey circle", "Dragon roost",
      "Sunken village", "Haunted manor", "Bandit camp", "Druid grove", "Ancient statue", "Collapsed mine",
      "Bridge over chasm", "Forgotten prison", "Spider-infested ruin", "Cursed well",
      "Orc stronghold", "Elven outpost", "Smuggler's cove", "Crystal cave", "Meteor crater",
      "Frozen tomb", "Ghoul burrow", "Lich's sanctum", "Witch hut", "Maze of thorns",
      "Minotaur labyrinth", "Ancient aqueduct", "Singing stone", "Basilisk den", "Banshee’s glade",
      "Floating shrine", "Mirror pool", "Giant's bones", "Buried colossus", "Chasm of echoes",
      "Mage's laboratory", "Clockwork tower", "Golem forge", "Wyrm tunnel", "Crumbled fortification",
      "Sapphire spring", "Hidden monastery", "Mystic tree", "Treant grove", "Ice cave",
      "Troll bridge", "Cursed orchard", "Ruined arena", "Desert spire", "Shifting dunes temple",
      "Cavern of whispers", "Fungal colony", "Altar of blood", "Crater lake", "Goblin market",
      "Fire giant forge", "Runestone circle", "Tomb of the nameless", "Celestial observatory",
      "Sunken colosseum", "Poisoned glade", "Wyvern cliff", "Shrine of forgotten gods",
      "Battlefield memorial", "Dragonbone cairn", "Cursed shipwreck", "Enchanted glade",
      "Blood-soaked altar", "Spectral barracks", "Stargazer’s retreat", "Portal arch",
      "Collapsed watchtower", "Echoing canyon", "Serpent's hollow", "Wraith-haunted crypt",
      "Darkwell spring", "Fey prison", "Ancient forge", "Obsidian mirror"
    ];

    const villageNames = [
      "Barrowshade", "Duskwatch", "Thornbend", "Fallowmere", "Wyrmrest", "Cobblebrook", "Elderfen", "Mossmere",
      "Redthicket", "Ashgrove", "Lowhill", "Brindlefield", "Hare's Hollow", "Stoneveil", "Whisperwill", "Tarncross",
      "Oldmere", "Fogwillow", "Blackbarrow", "Greenglen", "Hollowtree", "Ravenshade", "Dunfield", "Meadrock",
      "Willowfen", "Oakrest", "Brassacre", "Cragmoor", "Goldmere", "Silvershade", "Duskmere", "Harthollow",
      "Crowridge", "Northrest", "Lanternhill", "Mudwarren", "Driftfield", "Embergrove", "Stillwater", "Marrowbank",
      "Foxden", "Nightbarrow", "Pinewatch", "Sootfield", "Quietreach", "Thistlebrook", "Wormroot", "Weepingrock",
      "Shademoor", "Runewell", "Witherby", "Coldacre", "Briarstead", "Snowsong", "Glowfen", "Hearthmere",
      "Deadwillow", "Sheephorn", "Burnt Elm", "Grub Hollow", "Wickerfold", "Houndmere", "Varmoor", "Tumbledown",
      "Ashmead", "Nettlebrook", "Bracken Hollow", "Lichenreach", "Sableacre", "Windmere", "Oldroot", "Crookfen",
      "Twilight Den", "Murkstead", "Bogbend", "Glumhaven", "Frostreach", "Lantern Hollow", "Whistlefen", "Dirtmoor",
      "Starfall Hollow", "Blackfen", "Thornbridge", "Gloomwill", "Wyrdfield", "Clawmere", "Swamphold", "Rotwood",
      "Driftfen", "Fennridge", "Oatfield", "Tallowmere", "Crowfen", "Stumpwatch", "Miregrove", "Rustmere",
      "Hag's End", "Oakshade", "Marshrest", "Grimhill", "Barrowfell", "Glowfield", "Wispstead", "Briarbrook"
    ];

    const townNames = [
      "Stonequay", "Halberd's Hollow", "Narrowdeep", "Thundertree", "Feymarch", "Crimson Hollow", "Greystone",
      "Ashbridge", "Wyrmgate", "Frostbarrow", "Daggerlark", "Emberdeep", "Saltmere", "Redhall", "Brightward",
      "Graveford", "Lanternspire", "Coldreach", "Ironmoor", "Stormwatch", "Hollowhearth", "Deepmere", "Ternbridge",
      "Thornmarch", "Bleakhollow", "Dustwell", "Shimmerbrook", "Candleholt", "Greenvault", "Ironpost", "Kestrel's Roost",
      "Fallmere", "Sunrest", "Whitemarsh", "Blightgate", "Cragside", "Truespire", "Darkmere", "Seawatch", "Tidehaven",
      "Hillgate", "Brimstead", "Blackmead", "Sablewatch", "Grimharbor", "Moonwell", "Stonewick", "Goldfield",
      "Duskgate", "Amberholt", "Shadowhaven", "Vyrestead", "Steelmarch", "Oldspire", "Wolfsrest", "Eaglepost",
      "Thornspire", "Mirebridge", "Veilstone", "Mournfield", "Grimsward", "Frostwick", "Falconhall", "Vinevale",
      "Crossfen", "Shiverstone", "Glenwatch", "Broodmere", "Ashpoint", "Talonreach", "Fallowglen", "Mistvale",
      "Torhall", "Rimeford", "Crowspire", "Gravewatch", "Tarnspire", "Ironvale", "Windmark", "Brightfen",
      "Embergate", "Ravensfell", "Seastone", "Glimmerfield", "Stormbarrow", "Whitedown", "Barrowmarch",
      "Netherstead", "Oakspire", "Silentmere", "Fellharbor", "Coldmoor", "Mirefield", "Dusksend", "Ghostmoor",
      "Bramblewatch", "Witchwater", "Starhaven", "Firegate", "Brightfall", "Swanhold", "Dunmarch", "Gravestone"
    ];

    const cityNames = [
      "Velthar", "Caramund", "Ironcrest", "Thalvaren", "Yrnath", "Khalden", "Stormspire", "Maelbrith",
      "Dunvahr", "Sablethorn", "Valthros", "Caer Dhun", "Nymera", "Eldreth", "Gravemarch", "Solgarde",
      "Ashovar", "Nerathos", "Drelmoor", "Highcairn", "Kyrantis", "Blackreach", "Aethryn", "Myrrith",
      "Varonhall", "Kelthar", "Glimmerdeep", "Dreadspire", "Cravenmoor", "Estharis", "Morwyn", "Raegarth",
      "Skelvarn", "Helmarra", "Ebonwatch", "Lorthwyn", "Avaris", "Duskspire", "Shadowcairn", "Felbraith",
      "Zarenth", "Ironglade", "Narvenholme", "Thulmar", "Vorgrim", "Brightspire", "Carrowyn", "Mournhollow",
      "Cindergate", "Tarnovar", "Stormgarde", "Runebarrow", "Feybraith", "Vharos", "Kelbaran", "Greyspire",
      "Marranth", "Sunharrow", "Ashenport", "Valthorne", "Durnath", "Wyrmbane", "Elarion", "Crownhold",
      "Mythgarde", "Velmorra", "Orrakar", "Dreadwatch", "Ironhearth", "Nyvos", "Talgrin", "Everblack",
      "Skarnath", "Rimeholt", "Urendor", "Sorrowfen", "Baelwyn", "Harrowdeep", "Sharador", "Thranovar",
      "Fellspire", "Gloomhollow", "Vaelstone", "Obsidian Gate", "Torvannis", "Nocthar", "Cindralis",
      "Glavemarch", "Severyn", "Ostergar", "Quenlar", "Arkendrel", "Kurnholde", "Duskenwall", "Farsummit",
      "Malgrith", "The Graven City", "Skyrath", "Bloodspire", "Yvranos", "Zulmorrah", "Halverad", "Thornport"
    ];

    const poiDevelopments = [
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Cataclysm",
      "Haunted by the ghosts of a lost battalion",
      "Sunk partially into the earth after an earthquake",
      "Cursed to be invisible at night",
      "Marked by celestial symbols that glow under moonlight",
      "Surrounded by a forest that moves at will",
      "Temporarily frozen in time",
      "Echoes with the laughter of unseen children",
      "Used as a testing ground for forbidden magic",
      "Under the protection of a giant stone golem",
      "Swallowed and spat out by the earth once every decade",
      "Contains a mirror that shows future disasters",
      "Filled with books that rewrite themselves nightly",
      "Watched by an ever-growing statue",
      "Has bloodstains that never dry",
      "Hosts a dream cult that never wakes",
      "Covered in unnatural snow, even in summer",
      "Built atop an imprisoned demon",
      "Its shadows move in reverse",
      "Emits whispers that only animals understand",
      "A battlefield that resets each dawn",
      "Guarded by spectral knights bound by oath",
      "Burned down every full moon, then restored",
      "Hosts a council of talking animals",
      "Has walls carved with warnings in forgotten tongues",
      "A known gathering point for witches",
      "Site of a failed god's ascension",
      "Echoes with memories of those who visit",
      "Surrounded by trees with silver leaves",
      "Refuses to be mapped, paths change daily",
      "Subject to gravity shifts at irregular intervals",
      "Where time flows twice as fast",
      "Radiates intense emotions, fear, sorrow, desire",
      "Source of a strange glowing mist",
      "Controlled by intelligent rats",
      "Haunted by echoes of a singing ghost",
      "Home to a sentient fungus hive",
      "With a well that never runs dry, but steals voices",
      "Covered in carvings no tool could make",
      "Where stars shine during the day",
      "Built with unmelting ice",
      "Marked by giant claw marks in stone",
      "A place where metal rusts instantly",
      "Its light source is a floating crystal",
      "Has doorways that appear only when sung to",
      "Home to a creature that mimics visitors",
      "A site where every lie becomes truth",
      "Patrols of blind monks maintain order here",
      "The laws of physics are slightly wrong",
      "Where no birds will fly",
      "Every visitor forgets a name when they leave",
      "Tower that grows one inch taller each day",
      "Hums with the energy of a buried artifact",
      "Beneath a sky that's always sunset",
      "Bathed in eternal twilight",
      "Built by ants the size of dogs",
      "Enchanted so that all wounds heal, but dreams worsen",
      "All mirrors within show alternate realities",
      "Rain always falls upward here",
      "Voices sound like someone else's",
      "Creaks as if it were alive",
      "Marked on no known map",
      "The dead cannot remain dead here",
      "Once a city, now shrunk to dollhouse size",
      "Polished stone floors that show the past",
      "Ruled by a child claiming divine descent",
      "Attracts flocks of shadowy birds nightly",
      "Defended by ghostly war machines",
      "Has an altar that grants a wish, for a price",
      "Birthplace of a forgotten god",
      "Locals refuse to speak of it aloud",
      "Where the stars are wrong and shift hourly",
      "All written text becomes unreadable inside",
      "Entrances appear only during eclipses",
      "Sings with the voices of the drowned",
      "Inhabited by friendly but cursed spirits",
      "Contains a library that eats memories",
      "Surrounded by a moat of black ichor",
      "Its fire burns blue and cold",
      "All food within tastes like ash",
      "Visions of another world flicker at its edge",
      "Once a prison, still sealed from within",
      "Where shadows linger long after their owners leave",
      "Rain never stops, but nothing is ever wet",
      "Bathed in light, yet no sun shines",
      "Where ancient machines still run",
      "Home to a mask that makes one forget their face",
      "All colors appear inverted",
      "Children born here grow too fast",
      "With a fountain that restores youth, at a cost",
      "Surrounded by trees that whisper secrets",
      "Its bells ring only for the dying",
      "Time reverses when you walk counterclockwise",
      "You can hear your future self speaking in dreams",
      "Protected by a pact no one remembers",
      "No fire will stay lit inside",
      "Draws lightning daily, yet nothing burns",
      "The wind always carries a warning",
      "Home to an imprisoned celestial being",
      "Mapped only in dreams",
      "Site of a past apocalypse, soon to repeat"
    ];

    const cataclysmTypes = [
      "Volcano", "Fire", "Earthquake", "Hurricane", "Flood", "War", "Plague", "Supernatural disaster",
      "Meteor strike", "Landslide", "Tsunami", "Drought", "Blizzard", "Sandstorm", "Lightning storm",
      "Sinkhole collapse", "Civil war", "Mass exodus", "Economic collapse", "Religious schism"
    ];

    const baseTerrainTypes = [
      { name: "Desert", grayscale: '#dddddd', color: '#fceabb' },
      { name: "Swamp", grayscale: '#bbbbbb', color: '#c6e2c1' },
      { name: "Grassland", grayscale: '#999999', color: '#d5f5c9' },
      { name: "Forest", grayscale: '#777777', color: '#b0d9af' },
      { name: "River", grayscale: '#555555', color: '#ccefff' },
      { name: "Ocean", grayscale: '#333333', color: '#b2d4ee' },
      { name: "Mountain", grayscale: '#111111', color: '#ddd3c1' }
    ];

    // --- RANDOM UTILITIES ---
    function seededRandom(seed) {
      let x = Math.sin(seed++) * 10000;
      return x - Math.floor(x);
    }
    function seededChoice(seedRef, list) {
      const val = seededRandom(seedRef.value);
      seedRef.value++;
      return list[Math.floor(val * list.length)];
    }
    function seededDie(seedRef, sides) {
      return Math.floor(seededRandom(seedRef.value++) * sides) + 1;
    }
    function randomDie(sides) {
      return Math.floor(Math.random() * sides) + 1;
    }

    // --- DRAWING ---
    function hexToPixel(q, r, size) {
      const x = size * Math.sqrt(3) * (q + r / 2);
      const y = size * 3 / 2 * r;
      return [x, y];
    }
    function drawHex(x, y, size, fillColor, label, terrainName, dangerSymbol, hasPOI) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 180 * (60 * i - 30);
        const px = x + size * Math.cos(angle);
        const py = y + size * Math.sin(angle);
        i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fillStyle = fillColor;
      ctx.fill();
      ctx.strokeStyle = HEX_COLOR;
      ctx.lineWidth = 2;
      ctx.stroke();

      const blackTextTerrains = ["Desert", "Swamp"];
      const textColor = (!useGrayscale || blackTextTerrains.includes(terrainName)) ? '#000' : '#fff';
      ctx.fillStyle = textColor;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.font = '11px sans-serif';
      ctx.fillText(label, x, y - 10);
      ctx.font = '10px sans-serif';
      ctx.fillText(showDanger ? `${terrainName} - ${dangerSymbol}` : terrainName, x, y + 6);
      if (showDanger && hasPOI) {
        ctx.font = 'bold 9px sans-serif';
        ctx.fillText("PoI", x, y + 20);
      }
    }
    function getHexSpiral(radius) {
      const results = [{ q: 0, r: 0 }];
      const dirs = [{ q: 1, r: 0 }, { q: 1, r: -1 }, { q: 0, r: -1 }, { q: -1, r: 0 }, { q: -1, r: 1 }, { q: 0, r: 1 }];
      for (let k = 1; k <= radius; k++) {
        let q = dirs[4].q * k;
        let r = dirs[4].r * k;
        for (let side = 0; side < 6; side++) {
          const dir = dirs[side];
          for (let step = 0; step < k; step++) {
            results.push({ q, r });
            q += dir.q;
            r += dir.r;
          }
        }
      }
      return results;
    }
    function getTerrainColor(terrain) {
      return useGrayscale ? terrain.grayscale : terrain.color;
    }
    function updateLegendSwatches() {
      baseTerrainTypes.forEach(t => {
        const el = document.getElementById(`swatch-${t.name.toLowerCase()}`);
        if (el) el.style.background = getTerrainColor(t);
      });
    }

    // --- DANGER & DRAWGRID ---
    function dangerLevelSymbol(roll) {
      if (roll === 1) return 'S';
      if (roll <= 3) return 'U';
      if (roll <= 5) return 'R';
      return 'D';
    }
    function drawGrid(drawOnly = false) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!drawOnly) {
        dangerMap.clear();
        poiMap.clear();
        hexNumberMap.clear();
        poiListDiv.innerHTML = '';
      }

      const coords = getHexSpiral(MAP_RADIUS);
      const seedRef = { value: seed };
      let previousTerrain = seededChoice(seedRef, baseTerrainTypes);

      coords.forEach(({ q, r }, index) => {
        const hexId = index + 1;
        const key = `${q},${r}`;
        hexNumberMap.set(key, hexId);

        let terrain = terrainMap.get(key);
        if (!terrain) {
          if (seededRandom(seedRef.value++) < 1 / 36) {
            let newTerrain;
            do {
              newTerrain = seededChoice(seedRef, baseTerrainTypes);
            } while (newTerrain === previousTerrain);
            previousTerrain = newTerrain;
          }
          terrain = previousTerrain;
          terrainMap.set(key, terrain);
        }

        let danger = dangerMap.get(key);
        if (!drawOnly || !danger) {
          const dangerRoll = seededDie(seedRef, 6);
          danger = dangerLevelSymbol(dangerRoll);
          dangerMap.set(key, danger);
        }

        let hasPOI = poiMap.has(key);
        if (!drawOnly && randomDie(6) === 1) {
          let poiType = poiDescriptions[randomDie(poiDescriptions.length) - 1];
          if (poiType === "Village") poiType += ": " + villageNames[randomDie(villageNames.length) - 1];
          else if (poiType === "Town") poiType += ": " + townNames[randomDie(townNames.length) - 1];
          else if (poiType === "City") poiType += ": " + cityNames[randomDie(cityNames.length) - 1];

          let development = poiDevelopments[randomDie(poiDevelopments.length) - 1];
          if (development === "Cataclysm") {
            const cataclysm = cataclysmTypes[randomDie(cataclysmTypes.length) - 1];
            development = `Cataclysm: ${cataclysm}`;
          }

          const fullPOI = `${poiType} (${development})`;
          poiMap.set(key, fullPOI);
          hasPOI = true;
        }

        const [x, y] = hexToPixel(q, r, HEX_RADIUS);
        drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), hexId, terrain.name, danger, hasPOI);
      });

      if (showDanger && poiMap.size > 0) {
        const listItems = [...poiMap.entries()].map(([key, val]) => {
          const id = hexNumberMap.get(key);
          return `<li><strong>${id}</strong>: ${val}</li>`;
        });
        poiListDiv.innerHTML = `<h3>Points of Interest (DM only)</h3><ul>${listItems.join('')}</ul>`;
        poiListDiv.style.display = 'block';
      } else {
        poiListDiv.innerHTML = '';
        poiListDiv.style.display = 'none';
      }
    }

    // --- EVENT HANDLERS ---
    toggleColorMode.addEventListener('click', () => {
      useGrayscale = !useGrayscale;
      updateLegendSwatches();
      drawGrid(true);
    });
    toggleDangerButton.addEventListener('click', () => {
      showDanger = !showDanger;
      drawGrid(true);
    });
    newMapButton.addEventListener('click', () => {
      seed = Math.floor(Math.random() * 99999);
      terrainMap.clear();
      drawGrid(false);
    });

    canvas.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const size = HEX_RADIUS;
      const q = ((mouseX - canvas.width / 2) * Math.sqrt(3) / 3 - (mouseY - canvas.height / 2) / 3) / size;
      const r = ((mouseY - canvas.height / 2) * 2 / 3) / size;
      const rounded = hexRound(q, r);
      const key = `${rounded.q},${rounded.r}`;
      if (!terrainMap.has(key)) return;

      contextMenu.innerHTML = '';
      baseTerrainTypes.forEach(t => {
        const item = document.createElement('div');
        item.className = 'context-menu-item';
        item.innerHTML = `<span class="swatch" style="background:${getTerrainColor(t)}"></span>${t.name}`;
        item.onclick = () => {
          terrainMap.set(key, t);
          redrawHex(rounded.q, rounded.r);
          contextMenu.style.display = 'none';
        };
        contextMenu.appendChild(item);
      });

      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.style.display = 'block';
    });

    window.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });
    function redrawHex(q, r) {
      const key = `${q},${r}`;
      const terrain = terrainMap.get(key);
      const danger = dangerMap.get(key);
      const hasPOI = poiMap.has(key);
      const hexId = hexNumberMap.get(key);
      const [x, y] = hexToPixel(q, r, HEX_RADIUS);
      drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, getTerrainColor(terrain), hexId, terrain.name, danger, hasPOI);
    }
    function hexRound(qf, rf) {
      const sf = -qf - rf;
      let q = Math.round(qf);
      let r = Math.round(rf);
      let s = Math.round(sf);
      const dq = Math.abs(q - qf);
      const dr = Math.abs(r - rf);
      const ds = Math.abs(s - sf);
      if (dq > dr && dq > ds) q = -r - s;
      else if (dr > ds) r = -q - s;
      return { q, r };
    }

    // --- INITIAL DRAW ---
    drawGrid();
    updateLegendSwatches();

  </script>

</body>

</html>