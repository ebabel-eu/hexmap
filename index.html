<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hex Map Generator</title>
  <style>
    :root {
      --terrain-desert: #dddddd;
      --terrain-swamp: #bbbbbb;
      --terrain-grassland: #999999;
      --terrain-forest: #777777;
      --terrain-river: #555555;
      --terrain-ocean: #333333;
      --terrain-mountain: #111111;
    }

    body {
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      font-size: 12px;
    }

    canvas {
      background-color: #ffffff;
      display: block;
      margin: auto;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      gap: 20px;
      background: white;
      padding: 5px 10px;
      border: 1px solid #ccc;
      z-index: 1;
    }

    .legend ul {
      padding-left: 0;
      margin: 0;
    }

    .legend ul li {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid #000;
    }

    .context-menu {
      position: absolute;
      display: none;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 5px;
      cursor: pointer;
    }

    .context-menu-item:hover {
      background-color: #eee;
    }
  </style>
</head>
<body>

  <div class="legend">
    <ul>
      <li><span class="swatch" style="background: var(--terrain-desert);"></span> Desert</li>
      <li><span class="swatch" style="background: var(--terrain-swamp);"></span> Swamp</li>
      <li><span class="swatch" style="background: var(--terrain-grassland);"></span> Grassland</li>
      <li><span class="swatch" style="background: var(--terrain-forest);"></span> Forest</li>
      <li><span class="swatch" style="background: var(--terrain-river);"></span> River</li>
      <li><span class="swatch" style="background: var(--terrain-ocean);"></span> Ocean</li>
      <li><span class="swatch" style="background: var(--terrain-mountain);"></span> Mountain</li>
    </ul>
    <ul>
      <li>Walking: 4 hours</li>
      <li>Mounted: 2 hours</li>
      <li>Sailing: 1 hour</li>
      <li>Arduous terrain: 8 hours</li>
      <li>Difficult terrain: time x2</li>
    </ul>
  </div>

  <canvas id="hexMap" width="1000" height="1000"></canvas>
  <div id="contextMenu" class="context-menu"></div>

  <script>
    const canvas = document.getElementById('hexMap');
    const ctx = canvas.getContext('2d');
    const contextMenu = document.getElementById('contextMenu');

    const HEX_RADIUS = 44;
    const MAP_RADIUS = 6;
    const HEX_COLOR = '#000000';

    const style = getComputedStyle(document.documentElement);
    const terrainTypes = [
      { name: "Desert", color: style.getPropertyValue('--terrain-desert').trim() },
      { name: "Swamp", color: style.getPropertyValue('--terrain-swamp').trim() },
      { name: "Grassland", color: style.getPropertyValue('--terrain-grassland').trim() },
      { name: "Forest", color: style.getPropertyValue('--terrain-forest').trim() },
      { name: "River", color: style.getPropertyValue('--terrain-river').trim() },
      { name: "Ocean", color: style.getPropertyValue('--terrain-ocean').trim() },
      { name: "Mountain", color: style.getPropertyValue('--terrain-mountain').trim() }
    ];

    const terrainMap = new Map();

    function hexToPixel(q, r, size) {
      const x = size * Math.sqrt(3) * (q + r/2);
      const y = size * 3/2 * r;
      return [x, y];
    }

    function pixelToHex(x, y) {
      const size = HEX_RADIUS;
      const q = ((x - canvas.width / 2) * Math.sqrt(3)/3 - (y - canvas.height / 2) / 3) / size;
      const r = ((y - canvas.height / 2) * 2/3) / size;
      return hexRound(q, r);
    }

    function hexRound(qf, rf) {
      const sf = -qf - rf;
      let q = Math.round(qf);
      let r = Math.round(rf);
      let s = Math.round(sf);

      const dq = Math.abs(q - qf);
      const dr = Math.abs(r - rf);
      const ds = Math.abs(s - sf);

      if (dq > dr && dq > ds) q = -r - s;
      else if (dr > ds) r = -q - s;

      return { q, r };
    }

    function drawHex(x, y, size, fillColor, label, terrainName) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 180 * (60 * i - 30);
        const px = x + size * Math.cos(angle);
        const py = y + size * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fillStyle = fillColor;
      ctx.fill();
      ctx.strokeStyle = HEX_COLOR;
      ctx.lineWidth = 2;
      ctx.stroke();

      const blackTextTerrains = ["Desert", "Swamp"];
      const textColor = blackTextTerrains.includes(terrainName) ? '#000000' : '#ffffff';
      ctx.fillStyle = textColor;
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, x, y);
    }

    function roll2d6is12() {
      return Math.floor(Math.random() * 36) === 0;
    }

    function getHexSpiral(radius) {
      const results = [{ q: 0, r: 0 }];
      const directions = [
        { q: 1, r: 0 }, { q: 1, r: -1 }, { q: 0, r: -1 },
        { q: -1, r: 0 }, { q: -1, r: 1 }, { q: 0, r: 1 }
      ];

      for (let k = 1; k <= radius; k++) {
        let q = directions[4].q * k;
        let r = directions[4].r * k;

        for (let side = 0; side < 6; side++) {
          const dir = directions[side];
          for (let step = 0; step < k; step++) {
            results.push({ q, r });
            q += dir.q;
            r += dir.r;
          }
        }
      }

      return results;
    }

    function drawGrid() {
      terrainMap.clear();
      const coords = getHexSpiral(MAP_RADIUS);
      let previousTerrain = terrainTypes[Math.floor(Math.random() * terrainTypes.length)];

      for (const { q, r } of coords) {
        if (roll2d6is12()) {
          let newTerrain;
          do {
            newTerrain = terrainTypes[Math.floor(Math.random() * terrainTypes.length)];
          } while (newTerrain === previousTerrain);
          previousTerrain = newTerrain;
        }
        terrainMap.set(`${q},${r}`, previousTerrain);
        const [x, y] = hexToPixel(q, r, HEX_RADIUS);
        drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, previousTerrain.color, `${q},${r}`, previousTerrain.name);
      }
    }

    function redrawHex(q, r) {
      const terrain = terrainMap.get(`${q},${r}`);
      const [x, y] = hexToPixel(q, r, HEX_RADIUS);
      drawHex(x + canvas.width / 2, y + canvas.height / 2, HEX_RADIUS, terrain.color, `${q},${r}`, terrain.name);
    }

    canvas.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      const { q, r } = pixelToHex(mouseX, mouseY);

      if (!terrainMap.has(`${q},${r}`)) return;

      contextMenu.innerHTML = '';
      terrainTypes.forEach(t => {
        const item = document.createElement('div');
        item.className = 'context-menu-item';
        item.innerHTML = `<span class="swatch" style="background:${t.color}"></span>${t.name}`;
        item.onclick = () => {
          terrainMap.set(`${q},${r}`, t);
          redrawHex(q, r);
          contextMenu.style.display = 'none';
        };
        contextMenu.appendChild(item);
      });

      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.style.display = 'block';
    });

    window.addEventListener('click', () => {
      contextMenu.style.display = 'none';
    });

    drawGrid();
  </script>
</body>
</html>